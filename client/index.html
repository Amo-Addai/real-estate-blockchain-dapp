<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CoFundie Real Estate POC</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="" name="keywords">
  <meta content="" name="description">

  <!-- Google Fonts -->
  <!-- <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700" rel="stylesheet"> -->

  <!-- Bootstrap CSS File -->
  <!-- <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet"> -->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">

  <!-- Libraries CSS Files -->
  <!-- <link href="lib/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link href="lib/animate/animate.min.css" rel="stylesheet">
  <link href="lib/ionicons/css/ionicons.min.css" rel="stylesheet">
  <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet"> -->

  <!-- Main Stylesheet File -->
    <!-- <link href="css/app.css" rel="stylesheet"> -->
  <!-- <link href="css/style.css" rel="stylesheet"> -->

</head>
<body>
    <div id="app">
        
        <div class="container">            
            
            <br><br>       

            <div class="row">
                <div class="col-md-8 col-md-offset-2">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <div class="panel-title pull-left">Property Enlistments</div>
                            <div class="btn-group" style="float: right;">
                                <!--  -->
                                <ul class="nav navbar-nav navbar-right">
                                    <li class="dropdown">
                                        <a id="chosenAccount" href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                                            <!--  PUT CHOSEN ACCOUNT HERE  --> CHOOSE ACCOUNT  <span class="caret"></span>
                                        </a>
                                        <ul id="accountsList" class="dropdown-menu" role="menu">
                                            <!--     SPECIFY ALL AVALABLE ACCOUNTS       -->
                                            <li><a href="#">Item I</a></li>
                                            <li class="divider"></li>
                                            <li><a href="#">Other</a></li>
                                        </ul>
                                    </li>
                                </ul>
                                <!--  -->
                            </div>
                            <div class="clearfix"></div>
                        </div>

                        <!--     DISPLAY ALL ENLISTMENTS HERE, ACCORDING TO ACCOUNTS       -->
                        <div class="panel-body">
                            <!-- PUT A LIST OF PUBLIC ENLISTMENTS HERE -->
                            <div id="enlistmentsTableDiv" class="table-responsive">
                                <table id="enlistmentsTable" class="table table-striped table-bordered table-hover">
                                    <tr id="enlistmentsTableHeader">
                                        <td>ID</td>
                                        <td>Landlord Name</td>
                                        <td>Street Name</td>
                                        <td>Status</td>
                                        <td>Smart Contract Address</td>
                                        <td>Action</td>
                                    </tr>
                                </table>
                            </div> <br />

                            <!-- PUT FORM FOR ADDING PUBLIC ENLISTMENTS HERE -->
                            <div id="enlistmentsFormDiv">
                                <form id="addEnlistmentForm" class="form-inline" action="#" method="POST">
                                    <div class="form-group">
                                        <!-- <label for="landlordName">Landlord Name</label> -->
                                        <input type="text" class="form-control" id="enl-landlordName"
                                            placeholder="Landlord Name">
                                    </div>

                                    <div class="form-group">
                                        <!-- <label for="streetName">Street Name</label> -->
                                        <input type="text" class="form-control" id="streetName"
                                            placeholder="Street Name">
                                    </div>

                                    <div class="form-group">
                                        <!-- <label for="house">House Number</label> -->
                                        <input type="number" class="form-control" id="house"
                                            placeholder="House Number">
                                    </div>

                                    <div class="form-group">
                                        <!-- <label for="floor">Floor Number</label> -->
                                        <input type="number" class="form-control" id="floor"
                                            placeholder="Floor Number">
                                    </div>

                                    <div class="form-group">
                                        <!-- <label for="apartment">Apartment Number</label> -->
                                        <input type="number" class="form-control" id="apartment"
                                            placeholder="Apartment Number">
                                    </div>

                                    <div class="form-group">
                                        <!-- <label for="zipCode">ZipCode</label> -->
                                        <input type="number" class="form-control" id="zipCode"
                                            placeholder="ZipCode">
                                    </div>
    
                                    <div class="form-group">
                                        <button type="submit" id="addEnlistmentFormSubmit" class="addeditFormSubmit btn btn-default">Save</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <br><br>       

            <div class="row">
                <div class="col-md-8 col-md-offset-2">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <div class="panel-title pull-left">Enlistment Offers</div>
                            <div class="btn-group" style="float: right;">
                                <!--  -->
                                <ul class="nav navbar-nav navbar-right">
                                    <li class="dropdown">
                                        <a href="#" class="chosenEnlistment dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                                                <!-- PUT CHOSEN ENLISTMENT HERE   -->
                                                CHOSEN ENLISTMENT  <span class="caret"></span>
                                        </a>
                                        <ul class="approvedEnlistmentsList dropdown-menu" role="menu">
                                            <!--     SPECIFY ALL AVALABLE ENLISTMENTS       -->
                                            <li><a href="#">Item I</a></li>
                                            <li class="divider"></li>
                                            <li><a href="#">Other</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                            <div class="clearfix"></div>
                        </div>

                        <!--     DISPLAY ALL OFFERS HERE, ACCORDING TO ENLISTMENTS       -->
                        <div class="panel-body">
                            <!-- PUT A LIST OF PUBLIC OFFERS HERE -->
                            <div id="offersTableDiv" class="table-responsive">
                                <table id="offersTable" class="table table-striped table-bordered table-hover">
                                    <tr id="offersTableHeader">
                                        <td>Initialized</td>
                                        <td>Tenant Name</td>
                                        <td>Tenant Email</td>
                                        <td>Amount</td>
                                        <td>Status</td>
                                        <td>Action</td>
                                    </tr>
                                </table>
                            </div> <br />

                            <!-- PUT FORM FOR ADDING PUBLIC OFFERS HERE -->
                            <div id="offersFormDiv">
                                <form id="addOfferForm" class="form-inline" action="#" method="POST">
                                    <div class="form-group">
                                        <!-- <label for="tenantName">Tenant Name</label> -->
                                        <input type="text" class="form-control" id="off-tenantName"
                                            placeholder="Tenant Name">
                                    </div>

                                    <div class="form-group">
                                        <!-- <label for="tenantEmail">Tenant Email</label> -->
                                        <input type="email" class="form-control" id="off-tenantEmail"
                                            placeholder="Tenant Email">
                                    </div>

                                    <div class="form-group">
                                        <!-- <label for="amount">Amount</label> -->
                                        <input type="number" class="form-control" id="off-amount"
                                            placeholder="Amount">
                                    </div>

                                    <div class="form-group">
                                        <button type="submit" id="addOfferFormSubmit" class="addeditFormSubmit btn btn-default">Save</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <br><br>       

            <div class="row">
                <div class="col-md-8 col-md-offset-2">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <div class="panel-title pull-left">Enlistment Agreements</div>
                            <div class="btn-group" style="float: right;">
                                <!--  -->
                                <ul class="nav navbar-nav navbar-right">
                                    <li class="dropdown">
                                        <a href="#" class="chosenEnlistment dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                                                <!-- PUT CHOSEN ENLISTMENT HERE   -->
                                                CHOSEN ENLISTMENT  <span class="caret"></span>
                                        </a>
                                        <ul class="approvedEnlistmentsList dropdown-menu" role="menu">
                                            <!--     SPECIFY ALL AVALABLE ENLISTMENTS       -->
                                            <li><a href="#">Item I</a></li>
                                            <li class="divider"></li>
                                            <li><a href="#">Other</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                            <div class="clearfix"></div>
                        </div>

                        <!--     DISPLAY ALL AGREEMENTS HERE, ACCORDING TO ENLISTMENTS       -->
                        <div class="panel-body">
                            <!-- PUT A LIST OF PUBLIC AGREEMENTS HERE -->
                            <div id="agreementsTableDiv" class="table-responsive">
                                <table id="agreementsTable" class="table table-striped table-bordered table-hover">
                                    <tr id="agreementsTableHeader">
                                        <td>Landlord Name</td>
                                        <td>Tenant Name</td>
                                        <td>Tenant Email</td>
                                        <td>Amount</td>
                                        <td>Status</td>
                                        <td>Action</td>
                                    </tr>
                                </table>
                            </div> <br />

                            <!-- PUT FORM FOR ADDING PUBLIC AGREEMENTS HERE -->
                            <div id="agreementsFormDiv">
                                <form id="addAgreementForm" class="form-inline" action="#" method="POST">
                                    <div class="form-group">
                                        <!-- <label for="landlordName">Landlord Name</label> -->
                                        <input type="text" class="form-control" id="agr-landlordName"
                                            placeholder="Landlord Name">
                                    </div>
                                    <div class="form-group">
                                        <!-- <label for="tenantName">Tenant Name</label> -->
                                        <input type="text" class="form-control" id="agr-tenantName"
                                            placeholder="Tenant Name">
                                    </div>
                                    <div class="form-group">
                                        <!-- <label for="tenantEmail">Tenant Email</label> -->
                                        <input type="email" class="form-control" id="agr-tenantEmail"
                                            placeholder="Tenant Email">
                                    </div>
                                    <div class="form-group">
                                        <!-- <label for="amount">Amount</label> -->
                                        <input type="number" class="form-control" id="agr-amount"
                                            placeholder="Amount">
                                    </div>
                                    <div class="form-group">
                                        <!-- <label for="leasePeriod">Lease Period</label> -->
                                        <input type="number" class="form-control" id="leasePeriod"
                                            placeholder="Lease Period">
                                    </div>
                                    <div class="form-group">
                                        <!-- <label for="otherTerms">Other Terms</label> -->
                                        <input type="text" class="form-control" id="otherTerms"
                                            placeholder="Other Terms">
                                    </div>

                                    <div class="form-group">
                                        <button type="submit" id="addAgreementFormSubmit" class="addeditFormSubmit btn btn-default">Save</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        
                    </div>
                </div>
            </div> 
            
            <br><br>   

        </div>

        <!--  -->

        <div class="modal fade" id="edit" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title custom_align" id="Heading">Edit Your Detail</h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <input id="editname" class="form-control " type="text" placeholder="Full Name">
                        </div>
                        <div class="form-group">
                            <input id="editemail" class="form-control " type="text" placeholder="Email">
                        </div>
                    </div>
                    <div class="modal-footer ">
                        <button type="button" class="addeditFormSubmit btn btn-warning btn-lg" data-dismiss="modal" aria-hidden="true" style="width: 100%;"><span class="glyphicon glyphicon-ok-sign"></span> Update</button>
                    </div>
                </div>
                <!-- /.modal-content --> 
            </div>
            <!-- /.modal-dialog --> 
        </div>
        
        <!--  -->
        
        <div class="modal fade" id="delete" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title custom_align" id="Heading">Delete this entry</h4>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <span class="glyphicon glyphicon-warning-sign">
                            </span> Are you sure you want to delete this?
                        </div> 
                    </div>
                    <div class="modal-footer ">
                        <button id="yesdelete" type="button" class="btn btn-danger" data-dismiss="modal" aria-hidden="true" ><span class="glyphicon glyphicon-ok-sign"></span> Yes</button>
                        <button id="nodelete" type="button" class="btn btn-warning" data-dismiss="modal" aria-hidden="true" ><span class="glyphicon glyphicon-remove"></span> No</button>
                    </div>
                </div>
                <!-- /.modal-content --> 
            </div>
            <!-- /.modal-dialog --> 
        </div>

        <!--  -->

        <div class="modal fade" id="reviewEnlistment" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title custom_align" id="Heading">Review this Enlistment</h4>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <span class="glyphicon glyphicon-warning-sign">
                            </span> How do you want to review this?
                        </div> 
                    </div>
                    <div class="modal-footer ">
                        <button id="approve" type="button" class="btn btn-danger" data-dismiss="modal" aria-hidden="true" ><span class="glyphicon glyphicon-ok-sign"></span> Approve</button>
                        <button id="reject" type="button" class="btn btn-warning" data-dismiss="modal" aria-hidden="true" ><span class="glyphicon glyphicon-remove"></span> Reject</button>
                    </div>
                </div>
                <!-- /.modal-content --> 
            </div>
            <!-- /.modal-dialog --> 
        </div>
    
        <!--  -->

        <div class="modal fade" id="reviewOffer" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title custom_align" id="Heading">Review this Offer</h4>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <span class="glyphicon glyphicon-warning-sign">
                            </span> How do you want to review this?
                        </div> 
                    </div>
                    <div class="modal-footer ">
                        <button id="approveOffer" type="button" class="btn btn-danger" data-dismiss="modal" aria-hidden="true" ><span class="glyphicon glyphicon-ok-sign"></span> Accept</button>
                        <button id="rejectOffer" type="button" class="btn btn-warning" data-dismiss="modal" aria-hidden="true" ><span class="glyphicon glyphicon-remove"></span> Reject</button>
                    </div>
                </div>
                <!-- /.modal-content --> 
            </div>
            <!-- /.modal-dialog --> 
        </div>
    
        <!--  -->

        <div class="modal fade" id="reviewAgreement" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h4 class="modal-title custom_align" id="Heading">Review this Agreement</h4>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <span class="glyphicon glyphicon-warning-sign">
                            </span> How do you want to review this?
                        </div> 
                    </div>
                    <div class="modal-footer ">
                        <button id="approveAgreement" type="button" class="btn btn-danger" data-dismiss="modal" aria-hidden="true" ><span class="glyphicon glyphicon-ok-sign"></span> Confirm</button>
                        <button id="rejectAgreement" type="button" class="btn btn-warning" data-dismiss="modal" aria-hidden="true" ><span class="glyphicon glyphicon-remove"></span> Reject</button>
                    </div>
                </div>
                <!-- /.modal-content --> 
            </div>
            <!-- /.modal-dialog --> 
        </div>
    
        <!--  -->

    </div>

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <!-- Latest compiled Bootstrap JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>

    <!-- JavaScripts Libraries -->
    <!-- <script src="js/app.js'"></script> -->
    <!-- <script src="js/main.js'"></script> -->

    <script type="text/javascript">
        console.log("HOME PAGE...");
        window.localStorage.setItem("web", "http://localhost:8080/");
        window.localStorage.setItem("api", "http://localhost:8080/"); // api/
        let accounts = ['Account Address: 0x627306090abaB3A6e1400e9345bC60c78a8BEf57'],
        approvedEnlistments = [];
        window.localStorage.setItem("accounts", JSON.stringify(accounts));
        window.localStorage.setItem("chosenAccount", accounts[0]);
        window.localStorage.setItem("approvedEnlistments", JSON.stringify(approvedEnlistments));
        window.localStorage.setItem("chosenEnlistment", JSON.stringify(approvedEnlistments[0]));
        window.localStorage.setItem("data", []);
        window.localStorage.setItem("editMode", false);
        window.localStorage.setItem("editId", "");
        window.localStorage.setItem("deleteId", "");
        window.localStorage.setItem("reviewId", "");
        window.localStorage.setItem("reviewTenantEmail", "");

        window.onload = function () { //   <span class="caret"></span>
            $("#chosenAccount").html(window.localStorage.getItem("chosenAccount") + '   <span class="caret"></span>');
            $("#accountsList").html("");
            // FIRST POPOULATE THE ACCOUNT LIST ITEMS
            var accounts = JSON.parse(window.localStorage.getItem("accounts"));
            for (let db of accounts) {
                $("#accountsList").append('<li><a id="' + db + '" href="#">' + db + '</a></li>');
            }
            $("#accountsList").click(function (e) {
                // e.target is our targetted element so e.target.nodeName is "A"
                if (e.target && e.target.nodeName == "A") {
                    var x = e.target.id;
                    window.localStorage.setItem("chosenAccount", x);
                    $("#chosenAccount").html(x + '   <span class="caret"></span>');
                    console.log(x + " was clicked");
                    getData();
                }
            });
            var approvedEnlistments = JSON.parse(window.localStorage.getItem("approvedEnlistments")), label = "";
            $(".approvedEnlistmentsList").html("");
            for (let db of approvedEnlistments) {
                label = "" + db.id + ". " + db.landlordName + " - " + db.streetName;
                $(".approvedEnlistmentsList").append('<li><a id="' + db.id + '" href="#">' + label + '</a></li>');
            }
            $(".approvedEnlistmentsList").click(async function (e) {
                e.preventDefault();
                // e.stopPropagation();
                // e.target is our targetted element so e.target.nodeName is "A"
                if (e.target && e.target.nodeName == "A") {
                    var x = e.target.id;
                    var db = await findObject(x);
                    window.localStorage.setItem("chosenEnlistment", JSON.stringify(db));
                    label = "" + db.id + ". " + db.landlordName + " - " + db.streetName;
                    $(".chosenEnlistment").html(label + '   <span class="caret"></span>');
                    console.log(x + " was clicked");
                    getEnlistmentOfferAndAgreementData(db);
                }
            });

            async function getRow(e, thisObj){
                return new Promise((resolve, reject) => {
                    var row = null;
                    if(e.target === thisObj && e.target.nodeName === "BUTTON") row = e.target.parentNode.parentNode;
                    else if(e.target.nodeName === "SPAN") row = e.target.parentNode.parentNode.parentNode;
                    else {
                        alert("Sorry, some error occured");
                    }
                    resolve(row);
                });
            }

            async function findObject (id){
                return new Promise((resolve, reject) => {
                    var data = JSON.parse(window.localStorage.getItem("data"));
                    for(var obj of data){
                        if(obj.id == id) resolve(obj);
                    }
                    resolve(null);
                });
            }
            
            
            async function handleAction (action, row = null, id = null){
                if(row != null && row != undefined){
                    id = row.id || "";
                    var obj = await findObject(id);
                    console.log("OBJ -> " + JSON.stringify(obj));
                    if(obj) { // SHOW A REVIEW ENLISTMENT ("APPROVE OR REJECT?") DIALOG BOX, BEFORE CALLING THE API
                        window.localStorage.setItem("reviewId", id);
                        // NOW, CONTINUE ON TO APPROVE / REJECT THE PROPERTY ENLISTMENT ..
                        var result = await makeRequest("enlistments/" + id + "/" + action, "POST");
                        if(result){ // VERY TERRIBLE API, DOESN'T RETURN ANY SUCCESS / FAILURE RESULT :(
                            console.log("RESULT -> " + JSON.stringify(result));
                        } 
                        console.log("RELOADING DATA ...");
                        getData();
                        window.localStorage.setItem("reviewId", "");
                    } else alert("Sorry, some error occured");
                } else if (id != null && id != undefined) {
                    // NOW, CONTINUE ON TO APPROVE / REJECT THE PROPERTY ENLISTMENT ..
                    var result = await makeRequest("enlistments/" + id + "/" + action, "POST");
                    if(result){ // VERY TERRIBLE API, DOESN'T RETURN ANY SUCCESS / FAILURE RESULT :(
                        console.log("RESULT -> " + JSON.stringify(result));
                    } 
                    console.log("RELOADING DATA ...");
                    getData();
                    window.localStorage.setItem("reviewId", "");
                }
            }

            async function handleSubAction (sub, action, { id, tenantEmail, approved }){
                console.log("SUB ACTION -> " + sub + " : " + action);
                console.log("BODY -> " + JSON.stringify({ id, tenantEmail, approved }));
                result = null;
                if(sub === "offer" && ["approve", "reject"].includes(action)){
                    result = await makeRequest("enlistments/" + id + "/offers/review", "POST", null, { tenantEmail, approved });
                } else if (sub === "agreement" && ["approve", "reject"].includes(action)) {
                    result = await makeRequest("enlistments/" + id + "/agreements/review", "POST", null, { tenantEmail, confirmed: approved });
                }
                if(result){ // VERY TERRIBLE API, DOESN'T RETURN ANY SUCCESS / FAILURE RESULT YET :(
                    console.log("RESULT -> " + JSON.stringify(result));
                } 
                console.log("RELOADING SUB-DATA ...");
                // window.localStorage.setItem("reviewId", "");
                getEnlistmentOfferAndAgreementData(await findObject(id));
            }

            $("#approve").click(function (e) { // 
                // e.preventDefault();
                // e.stopPropagation();
                id = window.localStorage.getItem("reviewId");
                console.log("ID !!!! -> " + id);
                handleAction("approve", null, id);
            });
            $("#reject").click(function (e) { // 
                // e.preventDefault();
                // e.stopPropagation();
                id = window.localStorage.getItem("reviewId");
                console.log("ID !!!! -> " + id);
                handleAction("reject", null, id);
            });
            // 
            $("#approveOffer").click(function (e) { // 
                // e.preventDefault();
                // e.stopPropagation();
                id = JSON.parse(window.localStorage.getItem("chosenEnlistment")).id;
                emailId = window.localStorage.getItem("reviewTenantEmail");
                handleSubAction("offer", "approve", { id, "tenantEmail": emailId, "approved": true });
            });
            $("#rejectOffer").click(function (e) { // 
                // e.preventDefault();
                // e.stopPropagation();
                id = JSON.parse(window.localStorage.getItem("chosenEnlistment")).id;
                emailId = window.localStorage.getItem("reviewTenantEmail");
                handleSubAction("offer", "reject", { id, "tenantEmail": emailId, "approved": false });
            });
            // 
            $("#approveAgreement").click(function (e) { // 
                // e.preventDefault();
                // e.stopPropagation();
                id = JSON.parse(window.localStorage.getItem("chosenEnlistment")).id;
                emailId = window.localStorage.getItem("reviewTenantEmail");
                handleSubAction("agreement", "approve", { id, "tenantEmail": emailId, "confirmed": true });
            });
            $("#rejectAgreement").click(function (e) { // 
                // e.preventDefault();
                // e.stopPropagation();
                id = JSON.parse(window.localStorage.getItem("chosenEnlistment")).id;
                emailId = window.localStorage.getItem("reviewTenantEmail");
                handleSubAction("agreement", "reject", { id, "tenantEmail": emailId, "confirmed": false });
            });
            // 

            function setupOnListItemClick (){

                $(".reviewEnlistmentButton").click(async function (e) { // 
                    var row = await getRow(e, this);
                    console.log("ROW NODE -> " + row.nodeName + " : ID -> " + row.id);
                    if(row != null && row != undefined){
                        var id = row.id || "";
                        var obj = await findObject(id);
                        console.log("OBJ -> " + JSON.stringify(obj));
                        if(obj) { // SHOW A REVIEW ("APPROVE / REJECT ?") DIALOG BOX, BEFORE PERFORMING ACTION
                            window.localStorage.setItem("reviewId", id);
                        } else alert("Sorry, some error occured");
                    } else alert("Sorry, some error occured");
                });
                $(".reviewOfferButton").click(async function (e) { // 
                    var row = await getRow(e, this);
                    console.log("ROW -> " + row);
                    console.log("ROW NODE -> " + row.nodeName + " : ID -> " + row.id);
                    if(row != null && row != undefined){
                        var id = row.id || null; // id IS tenantEmail
                        if(id) { // SHOW A REVIEW ("APPROVE / REJECT ?") DIALOG BOX, BEFORE PERFORMING ACTION
                            console.log("EMAIL ID -> " + JSON.stringify(id));
                            window.localStorage.setItem("reviewTenantEmail", id);
                        } else alert("Sorry, some error occured");
                    } else alert("Sorry, some error occured");
                });
                $(".reviewAgreementButton").click(async function (e) { // 
                    var row = await getRow(e, this);
                    console.log("ROW -> " + row);
                    console.log("ROW NODE -> " + row.nodeName + " : ID -> " + row.id);
                    if(row != null && row != undefined){
                        var id = row.id || null; // id IS tenantEmail
                        if(id) { // SHOW A REVIEW ("APPROVE / REJECT ?") DIALOG BOX, BEFORE PERFORMING ACTION
                            console.log("EMAIL ID -> " + JSON.stringify(id));
                            window.localStorage.setItem("reviewTenantEmail", id);
                        } else alert("Sorry, some error occured");
                    } else alert("Sorry, some error occured");
                });

                // THESE 2 AREN'T USE ANYMORE (FOR NOW ..)

                $(".approveEnlistmentButton").click(async function (e) { // 
                    // e.preventDefault();
                    // e.stopPropagation();
                    var row = await getRow(e, this);
                    console.log("ROW NODE -> " + row.nodeName + " : ID -> " + row.id);
                    handleAction("approve", row);
                });
                $(".rejectEnlistmentButton").click(async function (e) { // 
                    // e.preventDefault();
                    // e.stopPropagation();
                    var row = await getRow(e, this);
                    console.log("ROW NODE -> " + row.nodeName + " : ID -> " + row.id);
                    handleAction("reject", row);
                });

            } setupOnListItemClick(); // CALL THIS FUNCTION RIGHT AFTER DECLARING IT
       
            async function makeRequest(url="", method="", query=null, body=null){
                var _this = this;
                return new Promise(async (resolve, reject) => {
                    try {
                        var options = {
                            headers: {
                                // 'Authorization': 'Bearer ' + STH_TOKEN_HERE,
                                'Accept': 'application/json'
                            },
                            uri: window.localStorage.getItem('api') + url,
                            method: method
                        };
                        if(query) options["qs"] = query;
                        if(body && !(["GET", "DELETE"].includes(method)) ) options["body"] = body;
                        console.log("REQUEST OPTIONS -> " + JSON.stringify(options));
                        // 
                        $.ajax({
                            type: options.method,
                            headers: options.headers, 
                            // dataType: "json",
                            // contentType: 'application/json; charset=utf-8',
                            url: options.uri, // + ((query && options.qs && (Object.keys(options.qs).length > 0)) ? "?" + options.qs: ""),
                            data: options.body || null, 
                            success: function(res) {
                                // res = JSON.parse(res);
                                console.log("\nRESULT DATA -> " + JSON.stringify(res) + "\n");
                                resolve(res);
                            },
                            error: function(err) {
                                console.log("ERROR -> " + JSON.stringify(err))
                                resolve(null);
                            },
                            done: function() {
                                // console.log("DONE!!!");
                            }
                        });
                        // 
                    } catch (e) {
                        console.log("ERROR DURING REQUEST -> " + e);
                        resolve(null);
                    }
                });
            }


            async function getData() {
                var url =  + "enlistments", query = null; // "account=" + window.localStorage.getItem("chosenAccount");
                var data = await makeRequest("enlistments", "GET", query);
                window.localStorage.setItem("data", JSON.stringify(data));

                /* <tr id="enlistmentsTableHeader"><td>ID</td><td>Landlord</td><td>Street Name</td>
                    <td>Status</td><td>Smart Contract Address</td><td>Action</td></tr> */
                var table = $("#enlistmentsTable"), approvedEnlistments = [];
                table.find("tr:not(:first)").remove();
                for (var obj of data) {
                    table.append('<tr id="' + obj.id + '"><td>' + obj.id + '</td><td>' + obj.landlordName + '</td><td>' + obj.streetName + '</td>' +
                        '<td>' + obj.status + '</td><td>' + (obj.contractAddress || "-") + '</td>' +
                        '<td>' +  
                            '<button class="reviewEnlistmentButton btn btn-primary btn-sm pull-right" data-title="Review" data-toggle="modal" data-target="#reviewEnlistment" data-placement="top" rel="tooltip">' +
                                'Review' +
                            '</button>' +
                        '</td>' +
                    '</tr>');
                    if(obj.status == "APPROVED") approvedEnlistments.push(obj);
                }
                console.log(approvedEnlistments.length + " APPROVED ENLISTMENTS");
                $(".approvedEnlistmentsList").html("");
                for (let db of approvedEnlistments) {
                    label = "" + db.id + ". " + db.landlordName + " - " + db.streetName;
                    $(".approvedEnlistmentsList").append('<li><a id="' + db.id + '" href="#">' + label + '</a></li>');
                }
                setupOnListItemClick();
            } getData(); // CALL THIS FUNCTION RIGHT AFTER DECLARING IT


            async function getEnlistmentOfferAndAgreementData(enlistmentObj){
                console.log("GETTING OFFER & AGREEMENT DATA FOR ENLISTMENT -> " + JSON.stringify(enlistmentObj));
                // 
                var type = null, data = null;
                for(type of ["offer", "agreement"]){
                    data = await makeRequest("enlistments/" + enlistmentObj.id + "/" + type+"s", "GET");
                    window.localStorage.setItem(type+"Data", JSON.stringify(data));
                    switch(type){
                        case "offer": /* <tr id="offersTableHeader">
                            <td>Initialized</td><td>Tenant Name</td><td>Tenant Email</td><td>Amount</td><td>Status</td><td>Action</td> </tr> */
                            var table = $("#offersTable");
                            table.find("tr:not(:first)").remove();
                            for (var obj of data) { // THE MAIN UNIQUE PROP OF OFFERS IS .tenantEmail
                                table.append('<tr id="' + obj.tenantEmail + '"><td>' + (obj.initialized ? "Yes": "No") + '</td><td>' + obj.tenantName + '</td><td>' + 
                                    obj.tenantEmail + '</td><td>' + obj.amount + '</td>' + '<td>' + obj.status + '</td>' +
                                    '<td>' +  
                                        (obj.status === "ACCEPTED" ? '' : 
                                        '<button class="reviewOfferButton btn btn-primary btn-sm pull-right" data-title="Review" data-toggle="modal" data-target="#reviewOffer" data-placement="top" rel="tooltip">' +
                                            'Review' +
                                        '</button>') +
                                    '</td>' +
                                '</tr>');
                            }
                        break;
                        case "agreement": /* <tr id="agreementsTableHeader">
                            <td>Landlord Name</td><td>Tenant Name</td><td>Tenant Email</td><td>Amount</td><td>Status</td><td>Action</td> </tr> */
                            var table = $("#agreementsTable");
                            table.find("tr:not(:first)").remove();
                            for (var obj of data) {
                                table.append('<tr id="' + obj.tenantEmail + '"><td>' + obj.landlordName + '</td><td>' + obj.tenantName + 
                                    '</td><td>' + obj.tenantEmail + '</td><td>' + obj.amount + '</td>' + '<td>' + obj.status + '</td>' +
                                    '<td>' +  
                                        (obj.status === "ACCEPTED" ? '' : 
                                        '<button class="reviewAgreementButton btn btn-primary btn-sm pull-right" data-title="Review" data-toggle="modal" data-target="#reviewAgreement" data-placement="top" rel="tooltip">' +
                                            'Review' +
                                        '</button>') +
                                    '</td>' +
                                '</tr>');
                            }
                        break;
                    }
                }
                setupOnListItemClick();
            }


            $('#addEnlistmentFormSubmit').click(function(e){
                e.preventDefault();
                // console.log("PREVENTING RELOADING OF THIS PAGE, BUT STILL CALLING FORM'S 'onSubmit'");
                $('#addEnlistmentForm').submit(); 
            });
            $("#addEnlistmentForm").submit(async function (e) {
                e.preventDefault();
                // VALIDATION
                if(  
                    ( $("#enl-landlordName").val().length <= 0 ) ||
                    ( $("#streetName").val().length <= 0 )  ||
                    ( $("#house").val().length <= 0 )  ||
                    ( $("#floor").val().length <= 0 )  ||
                    ( $("#apartment").val().length <= 0 )  ||
                    ( $("#zipCode").val().length <= 0 ) 
                ) {
                    alert("Please fill form");
                    return;
                } 
                // 
                var enlistment = {
                    landlordName: $("#enl-landlordName").val(),
                    streetName: $("#streetName").val(),
                    house: $("#house").val(),
                    floor: $("#floor").val(),
                    apartment: $("#apartment").val(),
                    zipCode: $("#zipCode").val(),
                    "latitude": 58.3817947,
                    "longitude": 26.7321715
                };
    
                console.log("SENDING NEW ENLISTMENT -> " + JSON.stringify(enlistment));
                var result = await makeRequest("enlistments", "POST", null, enlistment); 
                if(result){
                    console.log("SENT NEW ENLISTMENT -> " + JSON.stringify(result));
                    $("#enl-landlordName").val("");
                    $("#streetName").val("");
                    $("#house").val("");
                    $("#floor").val("");
                    $("#apartment").val("");
                    $("#zipCode").val("");
                    getData();
                }
            });

            

            $('#addOfferFormSubmit').click(function(e){
                e.preventDefault();
                // console.log("PREVENTING RELOADING OF THIS PAGE, BUT STILL CALLING FORM'S 'onSubmit'");
                $('#addOfferForm').submit(); 
            });
            $("#addOfferForm").submit(async function (e) {
                e.preventDefault();
                // VALIDATION
                if(  
                    ( $("#off-tenantName").val().length <= 0 ) ||
                    ( $("#off-tenantEmail").val().length <= 0 )  ||
                    ( $("#off-amount").val().length <= 0 )
                ) {
                    alert("Please fill form");
                    return;
                } 
                var enlistment = null,
                offer = {
                    tenantName: $("#off-tenantName").val(),
                    tenantEmail: $("#off-tenantEmail").val(),
                    amount: $("#off-amount").val()
                };
                try {
                    enlistment = JSON.parse(window.localStorage.getItem("chosenEnlistment"));
                } catch (e){
                    alert("Property Enlistment not selected")
                    return;
                }
    
                console.log("SENDING NEW OFFER TO ENLISTMENT " + enlistment.id + " -> " + JSON.stringify(offer));
                var result = await makeRequest("enlistments/" + enlistment.id + "/offers", "POST", null, offer); 
                // if(result){
                    console.log("SENT NEW OFFER -> " + JSON.stringify(result));
                    $("#off-tenantName").val("");
                    $("#off-tenantEmail").val("");
                    $("#off-amount").val("");
                    getEnlistmentOfferAndAgreementData(enlistment);
                // }
            }); 
                        

   
            $('#addAgreementFormSubmit').click(function(e){
                e.preventDefault();
                // console.log("PREVENTING RELOADING OF THIS PAGE, BUT STILL CALLING FORM'S 'onSubmit'");
                $('#addAgreementForm').submit(); 
            });
            $("#addAgreementForm").submit(async function (e) {
                e.preventDefault();
                // VALIDATION
                if(  
                    ( $("#agr-landlordName").val().length <= 0 ) ||
                    ( $("#agr-tenantName").val().length <= 0 ) ||
                    ( $("#agr-tenantEmail").val().length <= 0 )  ||
                    ( $("#agr-amount").val().length <= 0 ) ||
                    ( $("#leasePeriod").val().length <= 0 )  ||
                    ( $("#otherTerms").val().length <= 0 )  
                ) {
                    alert("Please fill form");
                    return;
                } 
                var enlistment = null,
                agreement = {
                    landlordName: $("#agr-landlordName").val(),
                    tenantName: $("#agr-tenantName").val(),
                    tenantEmail: $("#agr-tenantEmail").val(),
                    amount: $("#agr-amount").val(),
                    leasePeriod: $("#leasePeriod").val(),
                    otherTerms: $("#otherTerms").val(),
                    agreementTenantName: $("#agr-tenantName").val(),
                    agreementTenantEmail: $("#agr-tenantEmail").val(),
                    "leaseStart": 1526228716370,
                    "handoverDate": 1526229189241,
                    "hash": "QmVrQUcG6XjUjtPuYRCfeKRaKZKkt8NBXYAEz4CiqczTLM"
                };
                try {
                    enlistment = JSON.parse(window.localStorage.getItem("chosenEnlistment"));
                } catch (e){
                    alert("Property Enlistment not selected")
                    return;
                }

                console.log("SENDING NEW AGREEMENT TO ENLISTMENT " + enlistment.id + " -> " + JSON.stringify(agreement));
                var result = await makeRequest("enlistments/" + enlistment.id + "/agreements", "POST", null, agreement); 
                // if(result){
                    console.log("SENT NEW AGREEMENT -> " + JSON.stringify(result));
                    $("#agr-landlordName").val("");
                    $("#agr-tenantName").val("");
                    $("#agr-tenantEmail").val("");
                    $("#agr-amount").val("");
                    $("#leasePeriod").val("");
                    $("#otherTerms").val("");
                    getEnlistmentOfferAndAgreementData(enlistment);
                // }
            });
               
        };
    </script>
</body>
</html>
